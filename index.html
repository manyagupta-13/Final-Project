<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Escape Room: The Abandoned Laboratory</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #e0e0e0;
        }
        
        #threejs-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #ui-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 5px;
            max-height: 30vh;
            overflow-y: auto;
            border: 1px solid #444;
            z-index: 2;
        }
        
        #inventory {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 5px;
            width: 200px;
            border: 1px solid #444;
            z-index: 2;
        }
        
        #inventory h3 {
            margin-top: 0;
            color: #8bc34a;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        
        #inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            background-color: rgba(68, 68, 68, 0.8);
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.9rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #222;
            padding: 30px;
            border-radius: 5px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #444;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-close:hover {
            color: #fff;
        }
        
        .interaction-buttons {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .interaction-button {
            background-color: #4a4a4a;
            color: #e0e0e0;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        
        .interaction-button:hover {
            background-color: #5a5a5a;
        }
        
        .interaction-button:disabled {
            background-color: #333;
            color: #777;
            cursor: not-allowed;
        }
        
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            gap: 10px;
            margin: 20px auto;
            width: fit-content;
        }
        
        .keypad button {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }
        
        .keypad-display {
            grid-column: span 3;
            background-color: #111;
            color: #f00;
            padding: 10px;
            text-align: center;
            font-family: monospace;
            font-size: 1.5rem;
            border: 1px solid #333;
            margin-bottom: 10px;
        }
        
        .success {
            color: #8bc34a;
        }
        
        .error {
            color: #f44336;
        }
        
        .hint {
            color: #aaa;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .pulsing {
            animation: pulse 2s infinite;
        }

        /* Crossword Puzzle Styles */
        .crossword-container {
            background-color: #333;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .crossword-grid {
            display: grid;
            grid-template-columns: repeat(5, 40px);
            grid-template-rows: repeat(5, 40px);
            gap: 2px;
            margin: 20px auto;
            justify-content: center;
        }
        
        .crossword-cell {
            width: 40px;
            height: 40px;
            background-color: #444;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .crossword-cell input {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 20px;
            text-align: center;
            text-transform: uppercase;
        }
        
        .crossword-cell input:focus {
            outline: 1px solid #8bc34a;
        }
        
        .crossword-clues {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .clue-list {
            width: 45%;
        }
        
        .clue-number {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            color: #8bc34a;
        }
        
        .crossword-success {
            color: #8bc34a;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            display: none;
        }

        /* Anagram Puzzle Styles */
        .anagram-letters {
            font-size: 24px;
            letter-spacing: 5px;
            margin: 20px 0;
            padding: 10px;
            background: #333;
            border-radius: 5px;
        }

        #anagram-feedback {
            margin-top: 15px;
            min-height: 30px;
        }
    </style>
</head>
<body>
    <div id="threejs-container"></div>
    
    <div id="inventory">
        <h3>Inventory</h3>
        <div id="inventory-items"></div>
    </div>
    
    <div id="ui-container">
        <div id="room-description">
            <p>Your head throbs as consciousness returns. The sterile scent of ethanol mixes with something more acrid - ozone? Burning? Your vision clears to reveal a dim laboratory, illuminated only by the flickering glow of dying fluorescent lights.</p>
            <p>The cold metal table beneath you explains the stiffness in your limbs. How long were you out? The last thing you remember is... nothing. Just darkness.</p>
            <p>A digital keypad by the reinforced door mocks you with its glowing red display: "LOCKED - ENTER 4-DIGIT CODE". The air feels thick with secrets and the weight of forgotten experiments.</p>
        </div>
    </div>

    <!-- Modal for interactions -->
    <div id="interaction-modal" class="modal">
        <div class="modal-content" id="modal-content">
            <span class="modal-close">&times;</span>
            <div id="modal-title"></div>
            <div id="modal-description"></div>
            <div id="modal-interactions"></div>
        </div>
    </div>

    <!-- Load Three.js and plugins from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>

    <script>
        // Initialize Three.js scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        
        // Enhanced lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
        directionalLight.position.set(5, 10, 5);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 1024;
        directionalLight.shadow.mapSize.height = 1024;
        scene.add(directionalLight);
        
        // Camera setup
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 5);
        
        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.getElementById('threejs-container').appendChild(renderer.domElement);
        
        // Controls with better navigation
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 1, 0);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 3;
        controls.maxDistance = 15;
        controls.maxPolarAngle = Math.PI * 0.9;

        // Room construction - only outer walls
        const roomSize = 15;
        const wallHeight = 7;
        const wallThickness = 0.5;

        // Floor
        const floor = new THREE.Mesh(
            new THREE.PlaneGeometry(roomSize, roomSize),
            new THREE.MeshStandardMaterial({ 
                color: 0x333333,
                roughness: 0.8
            })
        );
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);

        // Outer walls only (no internal dividers)
        const wallMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x222244,
            side: THREE.DoubleSide
        });
        
        // Left wall
        const leftWall = new THREE.Mesh(
            new THREE.PlaneGeometry(roomSize, wallHeight),
            wallMaterial
        );
        leftWall.position.set(-roomSize/2, wallHeight/2, 0);
        leftWall.rotation.y = Math.PI / 2;
        scene.add(leftWall);
        
        // Right wall
        const rightWall = new THREE.Mesh(
            new THREE.PlaneGeometry(roomSize, wallHeight),
            wallMaterial
        );
        rightWall.position.set(roomSize/2, wallHeight/2, 0);
        rightWall.rotation.y = -Math.PI / 2;
        scene.add(rightWall);
        
        // Back wall
        const backWall = new THREE.Mesh(
            new THREE.PlaneGeometry(roomSize, wallHeight),
            wallMaterial
        );
        backWall.position.set(0, wallHeight/2, -roomSize/2);
        scene.add(backWall);

        // Front wall with door opening
        const frontWallLeft = new THREE.Mesh(
            new THREE.PlaneGeometry(roomSize/2 - 1, wallHeight),
            wallMaterial
        );
        frontWallLeft.position.set(-roomSize/4 - 0.5, wallHeight/2, roomSize/2);
        scene.add(frontWallLeft);

        const frontWallRight = new THREE.Mesh(
            new THREE.PlaneGeometry(roomSize/2 - 1, wallHeight),
            wallMaterial
        );
        frontWallRight.position.set(roomSize/4 + 0.5, wallHeight/2, roomSize/2);
        scene.add(frontWallRight);

        // Ceiling
        const ceiling = new THREE.Mesh(
            new THREE.PlaneGeometry(roomSize, roomSize),
            new THREE.MeshStandardMaterial({ color: 0x111122 })
        );
        ceiling.position.set(0, wallHeight, 0);
        ceiling.rotation.x = Math.PI / 2;
        scene.add(ceiling);

        // Interactive objects
        const interactiveObjects = [];

        // Door (purple as you liked)
        const door = new THREE.Mesh(
            new THREE.BoxGeometry(2, 4, 0.1),
            new THREE.MeshStandardMaterial({ color: 0x8844ff })
        );
        door.position.set(0, 2, roomSize/2 - 0.05);
        door.castShadow = true;
        door.userData = {
            name: "Exit Door",
            description: "Reinforced steel door with a keypad. The only way out.",
            onClick: () => showDoorInteraction()
        };
        scene.add(door);
        interactiveObjects.push(door);

        // Keypad
        const keypad = new THREE.Mesh(
            new THREE.BoxGeometry(0.5, 0.3, 0.05),
            new THREE.MeshStandardMaterial({ color: 0x111111 })
        );
        keypad.position.set(0.8, 1.2, roomSize/2);
        scene.add(keypad);

        // Lab desk
        const desk = new THREE.Mesh(
            new THREE.BoxGeometry(3, 0.8, 1.5),
            new THREE.MeshStandardMaterial({ 
                color: 0x555555,
                roughness: 0.7
            })
        );
        desk.position.set(-3, 0.4, -3);
        desk.castShadow = true;
        desk.receiveShadow = true;
        desk.userData = {
            name: "Lab Desk",
            description: "Cluttered with research notes and equipment.",
            onClick: () => showDeskInteraction()
        };
        scene.add(desk);
        interactiveObjects.push(desk);

        // ===== ENHANCED CABINET =====
        const cabinet = new THREE.Group();
        cabinet.position.set(3, 1.5, -3);
        
        // Cabinet frame (wooden texture)
        const cabinetTexture = new THREE.MeshStandardMaterial({
            color: 0x5a3a2a,
            roughness: 0.7,
            metalness: 0.1
        });
        
        const cabinetFrame = new THREE.Mesh(
            new THREE.BoxGeometry(2, 3, 1),
            cabinetTexture
        );
        cabinetFrame.castShadow = true;
        cabinetFrame.receiveShadow = true;
        cabinet.add(cabinetFrame);
        
        // Drawers with handles
        const drawerPositions = [0.7, 0, -0.7];
        const drawerMaterials = [
            new THREE.MeshStandardMaterial({ color: 0x6b4b3a }), // Darker wood
            new THREE.MeshStandardMaterial({ color: 0x5a3a2a }), // Medium wood
            new THREE.MeshStandardMaterial({ color: 0x4a2a1a })  // Darkest wood
        ];

        const drawers = [];
        drawerPositions.forEach((yPos, i) => {
            const drawer = new THREE.Mesh(
                new THREE.BoxGeometry(1.8, 0.7, 0.9),
                drawerMaterials[i]
            );
            drawer.position.set(0, yPos, 0.05);
            drawer.castShadow = true;
            drawer.receiveShadow = true;
            
            // Add drawer handle
            const handleGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.2, 16);
            const handleMaterial = new THREE.MeshStandardMaterial({ color: 0xaaaaaa });
            const handle = new THREE.Mesh(handleGeometry, handleMaterial);
            handle.rotation.z = Math.PI/2;
            handle.position.set(0.8, yPos, 0.4);
            handle.castShadow = true;
            
            drawer.userData = {
                isDrawer: true,
                drawerNumber: i+1,
                locked: i !== 0 // First drawer unlocked
            };
            
            cabinet.add(drawer);
            cabinet.add(handle);
            drawers.push(drawer);
        });

        // Add cabinet legs
        const legGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.1, 16);
        const legPositions = [
            { x: 0.9, z: 0.45 },
            { x: -0.9, z: 0.45 },
            { x: 0.9, z: -0.45 },
            { x: -0.9, z: -0.45 }
        ];
        
        legPositions.forEach(pos => {
            const leg = new THREE.Mesh(legGeometry, new THREE.MeshStandardMaterial({ color: 0x333333 }));
            leg.position.set(pos.x, -1.55, pos.z);
            leg.castShadow = true;
            cabinet.add(leg);
        });

        cabinet.userData = {
            name: "Supply Cabinet",
            description: "A sturdy wooden cabinet with three drawers.",
            onClick: () => showCabinetInteraction(),
            isCabinet: true,
            drawers: drawers
        };
        scene.add(cabinet);
        interactiveObjects.push(cabinet);
        drawers.forEach(drawer => interactiveObjects.push(drawer));

        // ===== ENHANCED BOOKSHELF =====
        const bookshelf = new THREE.Group();
        bookshelf.position.set(0, 2.5, -4);

        // Bookshelf frame
        const frameMaterial = new THREE.MeshStandardMaterial({
            color: 0x3a2a1f,
            roughness: 0.6
        });
        
        const frame = new THREE.Mesh(
            new THREE.BoxGeometry(4, 5, 0.5),
            frameMaterial
        );
        frame.castShadow = true;
        frame.receiveShadow = true;
        bookshelf.add(frame);

        // Shelves
        const shelfPositions = [1.5, 0.5, -0.5, -1.5];
        shelfPositions.forEach(yPos => {
            const shelf = new THREE.Mesh(
                new THREE.BoxGeometry(3.8, 0.1, 0.4),
                frameMaterial
            );
            shelf.position.set(0, yPos, 0);
            shelf.castShadow = true;
            shelf.receiveShadow = true;
            bookshelf.add(shelf);
        });

        // Books - different colors and sizes
        const bookColors = [
            0x8b0000, 0x006400, 0x00008b, 0x8b008b, 
            0x8b4513, 0x2f4f4f, 0x4682b4, 0x556b2f
        ];
        
        for (let i = 0; i < 4; i++) {
            for (let j = 0; j < 8; j++) {
                const bookHeight = 0.5 + Math.random() * 0.5;
                const bookWidth = 0.2 + Math.random() * 0.1;
                const bookDepth = 0.15 + Math.random() * 0.05;
                
                const book = new THREE.Mesh(
                    new THREE.BoxGeometry(bookWidth, bookHeight, bookDepth),
                    new THREE.MeshStandardMaterial({ 
                        color: bookColors[j % bookColors.length],
                        roughness: 0.3
                    })
                );
                book.castShadow = true;
                book.receiveShadow = true;
                
                book.position.set(
                    -1.5 + j * 0.4,
                    shelfPositions[i] + bookHeight/2 + 0.05,
                    0.1
                );
                
                // Add book spine text
                const spineText = new THREE.Mesh(
                    new THREE.PlaneGeometry(bookWidth * 0.9, bookHeight * 0.8),
                    new THREE.MeshStandardMaterial({ 
                        color: 0xffffff,
                        transparent: true,
                        opacity: 0.7
                    })
                );
                spineText.position.set(
                    book.position.x,
                    book.position.y,
                    book.position.z + bookDepth/2 + 0.01
                );
                spineText.rotation.y = Math.PI;
                
                bookshelf.add(book);
                bookshelf.add(spineText);
            }
        }

        bookshelf.userData = {
            name: "Bookshelf",
            description: "A floor-to-ceiling bookshelf filled with scientific tomes.",
            onClick: () => showBookshelfInteraction()
        };
        scene.add(bookshelf);
        interactiveObjects.push(bookshelf);

        // ===== ENHANCED COMPUTER TERMINAL =====
        const terminal = new THREE.Group();
        terminal.position.set(2, 0.4, 2);

        // Computer base
        const base = new THREE.Mesh(
            new THREE.BoxGeometry(0.8, 0.1, 0.8),
            new THREE.MeshStandardMaterial({ color: 0x222222 })
        );
        base.castShadow = true;
        base.receiveShadow = true;
        terminal.add(base);

        // Monitor
        const monitor = new THREE.Mesh(
            new THREE.BoxGeometry(0.7, 0.5, 0.02),
            new THREE.MeshStandardMaterial({ color: 0x111111 })
        );
        monitor.position.set(0, 0.35, 0.4);
        monitor.castShadow = true;
        terminal.add(monitor);

        // Monitor screen
        const screen = new THREE.Mesh(
            new THREE.PlaneGeometry(0.65, 0.45),
            new THREE.MeshStandardMaterial({ 
                color: 0x00aa00,
                emissive: 0x00aa00,
                emissiveIntensity: 0.5
            })
        );
        screen.position.set(0, 0.35, 0.41);
        terminal.add(screen);

        // Keyboard
        const keyboard = new THREE.Mesh(
            new THREE.BoxGeometry(0.6, 0.02, 0.3),
            new THREE.MeshStandardMaterial({ color: 0x333333 })
        );
        keyboard.position.set(0, 0.1, 0.1);
        keyboard.castShadow = true;
        terminal.add(keyboard);

        // Add some keyboard keys
        for (let i = 0; i < 3; i++) {
            for (let j = 0; j < 10; j++) {
                const key = new THREE.Mesh(
                    new THREE.BoxGeometry(0.05, 0.02, 0.05),
                    new THREE.MeshStandardMaterial({ color: 0x555555 })
                );
                key.position.set(
                    -0.25 + j * 0.055,
                    0.11,
                    0.1 - i * 0.1
                );
                key.castShadow = true;
                terminal.add(key);
            }
        }

        terminal.userData = {
            name: "Computer Terminal",
            description: "An old CRT computer terminal with green monochrome display.",
            onClick: () => showComputerInteraction()
        };
        scene.add(terminal);
        interactiveObjects.push(terminal);

        // ===== ENHANCED PERIODIC TABLE =====
        const chart = new THREE.Group();
        chart.position.set(4, 1.5, 0);
        chart.rotation.y = -Math.PI/2;

        // Chart background
        const background = new THREE.Mesh(
            new THREE.PlaneGeometry(2, 1.5),
            new THREE.MeshStandardMaterial({ color: 0x88aaff })
        );
        background.receiveShadow = true;
        chart.add(background);

        // Create periodic table grid
        const gridMaterial = new THREE.LineBasicMaterial({ color: 0x000000 });
        const gridGeometry = new THREE.BufferGeometry();
        
        // Vertical lines
        const positions = [];
        for (let x = -0.9; x <= 0.9; x += 0.2) {
            positions.push(x, -0.75, 0.01, x, 0.75, 0.01);
        }
        
        // Horizontal lines
        for (let y = -0.75; y <= 0.75; y += 0.25) {
            positions.push(-0.9, y, 0.01, 0.9, y, 0.01);
        }
        
        gridGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        
        const grid = new THREE.LineSegments(gridGeometry, gridMaterial);
        chart.add(grid);

        // Add element boxes with "POSSESS" highlighted
        const elements = [
            { symbol: "H", x: -0.8, y: 0.5 },
            { symbol: "He", x: 0.8, y: 0.5 },
            // ... more elements would go here
            { symbol: "P", x: -0.6, y: -0.5, highlight: true },
            { symbol: "O", x: -0.4, y: -0.5, highlight: true },
            { symbol: "S", x: -0.2, y: -0.5, highlight: true },
            { symbol: "S", x: 0, y: -0.5, highlight: true },
            { symbol: "E", x: 0.2, y: -0.5, highlight: true },
            { symbol: "S", x: 0.4, y: -0.5, highlight: true }
        ];
        
        elements.forEach(el => {
            const canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            const context = canvas.getContext('2d');
            context.fillStyle = el.highlight ? '#ff0000' : '#ffffff';
            context.fillRect(0, 0, 64, 64);
            context.font = '24px Arial';
            context.fillStyle = '#000000';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(el.symbol, 32, 32);
            
            const texture = new THREE.CanvasTexture(canvas);
            const element = new THREE.Mesh(
                new THREE.PlaneGeometry(0.15, 0.15),
                new THREE.MeshStandardMaterial({ map: texture })
            );
            element.position.set(el.x, el.y, 0.02);
            chart.add(element);
        });

        chart.userData = {
            name: "Chemical Chart",
            description: "A periodic table with certain elements highlighted to spell 'POSSESS'.",
            onClick: () => showChartInteraction()
        };
        scene.add(chart);
        interactiveObjects.push(chart);

        // Whiteboard
        const whiteboard = new THREE.Mesh(
            new THREE.PlaneGeometry(2, 1.5),
            new THREE.MeshStandardMaterial({ color: 0xffffff })
        );
        whiteboard.position.set(-2, 1.5, 2.5);
        whiteboard.rotation.y = Math.PI;
        whiteboard.receiveShadow = true;
        whiteboard.userData = {
            name: "Whiteboard",
            description: "Covered in equations and diagrams.",
            onClick: () => showWhiteboardInteraction()
        };
        scene.add(whiteboard);
        interactiveObjects.push(whiteboard);

        // Safe (hidden behind books)
        const safe = new THREE.Mesh(
            new THREE.BoxGeometry(0.5, 0.5, 0.1),
            new THREE.MeshStandardMaterial({ color: 0x333333 })
        );
        safe.position.set(0, 1.5, -4.5);
        safe.visible = false;
        safe.userData = {
            name: "Hidden Safe",
            description: "A secure safe hidden behind the bookshelf.",
            onClick: () => showSafeInteraction()
        };
        scene.add(safe);
        interactiveObjects.push(safe);

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Game state
        const gameState = {
            inventory: [],
            discoveredClues: [],
            puzzlesSolved: 0,
            doorCode: Math.floor(1000 + Math.random() * 9000).toString(),
            storyProgress: 0,
            usedItems: [],
            endingsDiscovered: []
        };

        // Modal functionality
        const modal = document.getElementById('interaction-modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalDescription = document.getElementById('modal-description');
        const modalInteractions = document.getElementById('modal-interactions');
        const modalClose = document.querySelector('.modal-close');

        function showModal(title, description, interactions) {
            modalTitle.innerHTML = `<h2>${title}</h2>`;
            modalDescription.innerHTML = `<p>${description}</p>`;
            modalInteractions.innerHTML = interactions;
            modal.style.display = 'flex';
        }

        modalClose.onclick = function(e) {
            e.stopPropagation();
            modal.style.display = 'none';
        }

        // Prevent clicks on modal from reaching the scene
        modalContent.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Update inventory display
        function updateInventory() {
            const inventoryContainer = document.getElementById('inventory-items');
            inventoryContainer.innerHTML = '';
            
            gameState.inventory.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                itemElement.textContent = item.replace('-', ' ');
                inventoryContainer.appendChild(itemElement);
            });
        }

        // Add item to inventory
        function addToInventory(itemId) {
            if (!gameState.inventory.includes(itemId)) {
                gameState.inventory.push(itemId);
                updateInventory();
            }
        }

        // Add discovered clue
        function addClue(clueId) {
            if (!gameState.discoveredClues.includes(clueId)) {
                gameState.discoveredClues.push(clueId);
                gameState.puzzlesSolved++;
                updateStory();
            }
        }

        // Update story based on progress
        function updateStory() {
            const roomDesc = document.getElementById('room-description');
            
            let baseDescription = `
                <p>Your head throbs as consciousness returns. The sterile scent of ethanol mixes with something more acrid - ozone? Burning? Your vision clears to reveal a dim laboratory, illuminated only by the flickering glow of dying fluorescent lights.</p>
                <p>The cold metal table beneath you explains the stiffness in your limbs. How long were you out? The last thing you remember is... nothing. Just darkness.</p>
                <p>A digital keypad by the reinforced door mocks you with its glowing red display: "LOCKED - ENTER 4-DIGIT CODE". The air feels thick with secrets and the weight of forgotten experiments.</p>
            `;
            
            let additionalText = '';
            
            if (gameState.puzzlesSolved >= 3) {
                additionalText = `
                    <div class="story-reveal">
                        <p>As you explore, you notice references to "Project Phoenix" and "Subject 314". What kind of experiments were conducted here?</p>
                    </div>
                `;
            }
            
            roomDesc.innerHTML = baseDescription + additionalText;
        }

        // Object interaction functions
        function showDoorInteraction() {
            const interactions = `
                <div class="interaction-buttons">
                    <button class="interaction-button" onclick="showDoorCodeInput(event)">Examine Keypad</button>
<<<<<<< Updated upstream
                    <button class="interaction-button" onclick="showDoorNote(event)">Search Around Door</button>
=======
>>>>>>> Stashed changes
                </div>
            `;
            showModal("Exit Door", "The reinforced door is your only way out. A keypad demands a 4-digit code.", interactions);
        }

<<<<<<< Updated upstream
        function showDoorNote(e) {
            if (e) e.stopPropagation();
            if (!gameState.inventory.includes('door-note')) {
                addToInventory('door-note');
                addClue('door-note-found');
                
                const noteContent = `
                    <p>You find a hidden note near the door frame:</p>
                    <p style="font-style: italic; background: #333; padding: 10px; border-left: 3px solid #8bc34a;">
                        "Emergency code: Subject number (314) multiplied by catalyst constant (2.5, round down)"
                    </p>
                    <p>The numbers 314 appear frequently in the lab's notes.</p>
                `;
                
                showModal("Hidden Note Found", noteContent, `<button class="interaction-button" onclick="showDoorInteraction(event)">Back to Door</button>`);
            } else {
                showModal("Exit Door", "You've already found the hidden note near the door.", `<button class="interaction-button" onclick="showDoorInteraction(event)">Back to Door</button>`);
            }
        }
=======
>>>>>>> Stashed changes

        function showDoorCodeInput(e) {
            if (e) e.stopPropagation();
            let hint = '';
            if (gameState.inventory.includes('door-note')) {
                hint = `<p class="hint">The note says: 314 × 2.5 = 785 → ${gameState.doorCode}</p>`;
            } else {
                hint = '<p class="hint">Look for clues around the lab to find the code.</p>';
            }
            
            const keypadHTML = `
                <div class="keypad">
                    <div class="keypad-display" id="code-display">____</div>
                    <button onclick="addCodeDigit('1', event)">1</button>
                    <button onclick="addCodeDigit('2', event)">2</button>
                    <button onclick="addCodeDigit('3', event)">3</button>
                    <button onclick="addCodeDigit('4', event)">4</button>
                    <button onclick="addCodeDigit('5', event)">5</button>
                    <button onclick="addCodeDigit('6', event)">6</button>
                    <button onclick="addCodeDigit('7', event)">7</button>
                    <button onclick="addCodeDigit('8', event)">8</button>
                    <button onclick="addCodeDigit('9', event)">9</button>
                    <button onclick="addCodeDigit('0', event)">0</button>
<<<<<<< Updated upstream
                    <button onclick="clearCode(event)">C</button>
=======
                    <button onclick="clearCode(event)">CLEAR</button>
>>>>>>> Stashed changes
                    <button onclick="submitCode(event)">ENTER</button>
                </div>
                ${hint}
            `;
            
            showModal("Door Keypad", "Enter the 4-digit code to escape:", keypadHTML);
        }

        let currentCode = '';
        window.addCodeDigit = function(digit, e) {
            if (e) e.stopPropagation();
            if (currentCode.length < 4) {
                currentCode += digit;
                document.getElementById('code-display').textContent = 
                    currentCode.padEnd(4, '_').split('').join(' ');
            }
        }

        window.clearCode = function(e) {
            if (e) e.stopPropagation();
            currentCode = '';
            document.getElementById('code-display').textContent = '____';
        }

        window.submitCode = function(e) {
            if (e) e.stopPropagation();
            if (currentCode === gameState.doorCode) {
                document.getElementById('code-display').className = 'keypad-display success';
                document.getElementById('code-display').textContent = 'OPEN';
                
                setTimeout(() => {
                    showModal("Escaped!", `
                        <p>The door unlocks with a satisfying clunk. You've escaped!</p>
                        <p>As you leave, you glance back at the lab, its mysteries still unsolved...</p>
                    `, `<button class="interaction-button" onclick="location.reload()">Play Again</button>`);
                    
                    // Animate door opening
                    let angle = 0;
                    const maxAngle = Math.PI / 2;
                    function animateDoor() {
                        if (angle < maxAngle) {
                            angle += 0.01;
                            door.rotation.y = -angle;
                            requestAnimationFrame(animateDoor);
                        }
                    }
                    animateDoor();
                }, 1000);
            } else {
                document.getElementById('code-display').className = 'keypad-display error';
                document.getElementById('code-display').textContent = 'ERR';
                setTimeout(() => {
                    document.getElementById('code-display').className = 'keypad-display';
                    clearCode();
                }, 1000);
            }
        }

        function showDeskInteraction() {
            const interactions = `
                <div class="interaction-buttons">
                    <button class="interaction-button" onclick="searchDesk(event)">Search the Desk</button>
                </div>
            `;
            showModal("Lab Desk", "A stainless steel desk littered with research notes and equipment.", interactions);
        }

        function searchDesk(e) {
            if (e) e.stopPropagation();
            if (!gameState.inventory.includes('small-key')) {
                addToInventory('small-key');
                addClue('desk-searched');
                
                const result = `
                    <p>Under a stack of papers, you find a small brass key and a note with symbols: ☽, ★, ♞, ☀️</p>
                    <p class="story-reveal">The note reads: 'The transformation sequence must follow lunar phases.'</p>
                `;
                
                showModal("Desk Search Results", result, `<button class="interaction-button" onclick="showDeskInteraction(event)">Back to Desk</button>`);
            } else {
                showModal("Lab Desk", "You've already searched the desk thoroughly.", `<button class="interaction-button" onclick="showDeskInteraction(event)">Back to Desk</button>`);
            }
        }

        function showCabinetInteraction() {
            const interactions = `
                <div class="interaction-buttons">
                    <button class="interaction-button" onclick="openCabinetDrawer(1, event)">Open Top Drawer</button>
                    <button class="interaction-button" ${gameState.inventory.includes('small-key') ? '' : 'disabled'} 
                        onclick="openCabinetDrawer(2, event)">Open Middle Drawer</button>
                    <button class="interaction-button" ${gameState.inventory.includes('small-key') ? '' : 'disabled'} 
                        onclick="openCabinetDrawer(3, event)">Open Bottom Drawer</button>
                </div>
            `;
            showModal("Supply Cabinet", "A heavy steel cabinet with three drawers. Some are locked.", interactions);
        }

        function openCabinetDrawer(drawerNumber, e) {
            if (e) e.stopPropagation();
            
            const cabinetObj = interactiveObjects.find(obj => obj.userData.isCabinet);
            if (!cabinetObj) return;
            
            const drawer = cabinetObj.userData.drawers[drawerNumber - 1];
            if (!drawer) return;
            
            if (drawer.userData.locked) {
                if (drawerNumber === 1 || gameState.inventory.includes('small-key')) {
                    // Unlock the drawer
                    drawer.userData.locked = false;
                    
                    if (drawerNumber === 2 && !gameState.inventory.includes('usb-drive')) {
                        addToInventory('usb-drive');
                        gameState.usedItems.push('small-key');
                        addClue('cabinet-opened');
                        
                        const result = `
                            <p>You unlock and open drawer ${drawerNumber}. Inside is a USB drive labeled "Project Phoenix".</p>
                            <p class="story-reveal">A note with the USB reads: 'Emergency override code: ${gameState.doorCode}'</p>
                        `;
                        
                        // Animate drawer opening
                        gsap.to(drawer.position, {
                            z: 0.5,
                            duration: 0.5,
                            onComplete: () => {
                                showModal("Cabinet Contents", result, `
                                    <button class="interaction-button" onclick="showCabinetInteraction(event)">Back to Cabinet</button>
                                `);
                            }
                        });
                    } else {
                        showModal("Cabinet Drawer", `Drawer ${drawerNumber} is empty.`, `
                            <button class="interaction-button" onclick="showCabinetInteraction(event)">Back to Cabinet</button>
                        `);
                    }
                } else {
                    showModal("Locked Drawer", `Drawer ${drawerNumber} is locked. You need a key to open it.`, `
                        <button class="interaction-button" onclick="showCabinetInteraction(event)">Back to Cabinet</button>
                    `);
                }
            } else {
                // Drawer is already unlocked
                if (drawerNumber === 2 && !gameState.inventory.includes('usb-drive')) {
                    addToInventory('usb-drive');
                    const result = `
                        <p>The drawer contains a USB drive labeled "Project Phoenix".</p>
                        <p class="story-reveal">A note with the USB reads: 'Emergency override code: ${gameState.doorCode}'</p>
                    `;
                    showModal("Cabinet Contents", result, `
                        <button class="interaction-button" onclick="showCabinetInteraction(event)">Back to Cabinet</button>
                    `);
                } else {
                    showModal("Cabinet Drawer", `Drawer ${drawerNumber} is empty.`, `
                        <button class="interaction-button" onclick="showCabinetInteraction(event)">Back to Cabinet</button>
                    `);
                }
            }
        }

        function showBookshelfInteraction() {
            const interactions = `
                <div class="interaction-buttons">
                    <button class="interaction-button" onclick="browseBooks(event)">Browse Books</button>
                    <button class="interaction-button" onclick="checkBehindBooks(event)">Check Behind Books</button>
                </div>
            `;
            showModal("Bookshelf", "A collection of scientific tomes, some looking well-used.", interactions);
        }

        function browseBooks(e) {
            if (e) e.stopPropagation();
            addClue('books-browsed');
            
            const result = `
                <p>You find a cryptography book with a marked passage about celestial symbols and sequences.</p>
                <p class="story-reveal">The margin notes mention 'the sequence must be followed precisely'.</p>
            `;
            
            showModal("Cryptography Book", result, `<button class="interaction-button" onclick="showBookshelfInteraction(event)">Back to Bookshelf</button>`);
        }

        function checkBehindBooks(e) {
            if (e) e.stopPropagation();
            addClue('safe-discovered');
            
            // Make the safe visible
            safe.visible = true;
            
            const result = `
                <p>Shifting volumes reveals a wall safe with an unusual keypad - it displays scrambled letters instead of numbers.</p>
                <p>A small label reads: "Subject 314 holds the key".</p>
            `;
            
            showModal("Hidden Safe", result, `
                <button class="interaction-button" onclick="showSafeInteraction(event)">Examine Safe</button>
                <button class="interaction-button" onclick="showBookshelfInteraction(event)">Back to Bookshelf</button>
            `);
        }

        function showSafeInteraction(e) {
            if (e) e.stopPropagation();
            
            if (gameState.inventory.includes('subject-note')) {
                showAnagramPuzzle();
            } else {
                showModal("Letter Combination Safe", `
                    <p>The safe has 12 buttons displaying scrambled letters.</p>
                    <p>A small screen above shows: "Enter the hidden message from Subject 314".</p>
                    <p class="hint">You might need to find a clue about Subject 314 first.</p>
                `, `
                    <button class="interaction-button" onclick="modal.style.display='none'">Close</button>
                `);
            }
        }

        function showAnagramPuzzle() {
            const letters = "THEPOISONVESSELS".split('');
            const scrambledLetters = shuffleArray([...letters]).join(' ');
            
            showModal("Letter Combination Safe", `
                <p>Rearrange these letters to form the correct phrase:</p>
                <div class="anagram-letters">${scrambledLetters}</div>
                <p>Your note says: "Subject 314: le poisson steve"</p>
                <input type="text" id="anagram-input" size="20">
                <button class="interaction-button" onclick="checkAnagramSolution(event)">Submit</button>
                <div id="anagram-feedback"></div>
            `, `
                <button class="interaction-button" onclick="showSafeInteraction(event)">Back to Safe</button>
            `);
        }

        function checkAnagramSolution(e) {
            if (e) e.stopPropagation();
            const input = document.getElementById('anagram-input').value.toUpperCase().replace(/\s/g, '');
            const feedback = document.getElementById('anagram-feedback');
            
            if (input === "THEPOISONVESSELS") {
                feedback.innerHTML = '<p class="success">Correct! The safe opens with a hiss. Inside rests a USB drive labeled "Project Phoenix - Final Notes".</p>';
                addToInventory('usb-drive');
                addClue('safe-combination');
                safe.visible = false; // Hide the safe after opening
                addStoryReveal("A faint scent of lavender wafts from the safe's interior - the same smell you noticed when first waking up.");
            } else {
                feedback.innerHTML = '<p class="error">Incorrect! The safe beeps angrily. Try again.</p>';
            }
        }

        // Helper function to shuffle array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function showComputerInteraction() {
            const interactions = `
                <div class="interaction-buttons">
                    <button class="interaction-button" onclick="turnOnComputer(event)">Turn On Computer</button>
                    ${gameState.inventory.includes('usb-drive') ? 
                        `<button class="interaction-button" onclick="insertUSB(event)">Insert USB Drive</button>` : ''}
                </div>
            `;
            showModal("Computer Terminal", "An old computer terminal with a glowing screen.", interactions);
        }

        function turnOnComputer(e) {
            if (e) e.stopPropagation();
            addClue('computer-on');
            
            const result = `
                <p>The computer displays a login screen with username "DR.ALCHEM" already entered.</p>
                <p class="hint">The sticky note on the keyboard says: "Remember - password changes every full moon!"</p>
            `;
            
            showModal("Computer Login", result, `
<<<<<<< Updated upstream
                <button class="interaction-button" onclick="showCrosswordPuzzle(event)">Attempt Login</button>
=======
>>>>>>> Stashed changes
                <button class="interaction-button" onclick="showComputerInteraction(event)">Back to Computer</button>
            `);
        }

        // Crossword puzzle data
        const crosswordData = {
<<<<<<< Updated upstream
            solution: [
                ['S', 'E', 'R', 'U', 'M'],
                ['V', 'I', 'A', 'L', 'S'],
                ['D', 'N', 'A', 'T', 'E'],
                ['G', 'E', 'N', 'E', 'S'],
                ['M', 'O', 'L', 'E', 'C']
            ],
            across: {
                1: { clue: "Experimental liquid given to subjects", row: 0, col: 0, length: 5 },
                4: { clue: "Genetic material (abbr.)", row: 2, col: 0, length: 3 },
                5: { clue: "Units of heredity", row: 3, col: 0, length: 5 },
                6: { clue: "____ule (smallest unit of a compound)", row: 4, col: 0, length: 4 }
            },
            down: {
                1: { clue: "Glass containers for chemicals", row: 0, col: 1, length: 5 },
                2: { clue: "RNA's counterpart", row: 0, col: 2, length: 3 },
                3: { clue: "PH scale measures this", row: 0, col: 4, length: 3 }
            }
        };
=======

    solution: [
        ['S', 'E', 'R', 'U', 'M'],
        ['V', 'I', 'A', 'L', 'S'],
        ['G', 'E', 'N', 'E', 'S'],
        ['M', 'O', 'L', 'E', 'S'],
        ['A', 'T', 'O', 'M', 'S']
    ],
    across: {
        1: { clue: "Experimental liquid given to subjects", row: 0, col: 0, length: 5 },
        2: { clue: "Glass containers for chemicals", row: 1, col: 1, length: 5 },
        3: { clue: "Units of heredity", row: 2, col: 2, length: 5 },
        4: { clue: "Unit of measurement representing a specific number of particles", row: 3, col: 3, length: 5 },
        5: { clue: "Basic building blocks of chemistry", row: 4, col: 4, length: 5 }
    },
    down: {
        1: { clue: "Vertical clue 1", row: 0, col: 0, length: 5 },
        2: { clue: "Vertical clue 2", row: 0, col: 1, length: 5 },
        // Add more down clues as needed
    }

            };
>>>>>>> Stashed changes

        function showCrosswordPuzzle(e, withHints = false) {
            if (e) e.stopPropagation();
            
            // Build the crossword grid
            let gridHTML = '<div class="crossword-container">';
            gridHTML += '<h3>Laboratory Crossword</h3>';
            gridHTML += '<p>Solve the puzzle to reveal the password</p>';
            
            // Create the grid
            gridHTML += '<div class="crossword-grid">';
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const cellId = `cell-${row}-${col}`;
                    const cellValue = withHints && (row === 0 || col === 0) ? crosswordData.solution[row][col] : '';
                    const isLocked = withHints && (row === 0 || col === 0);
                    
                    // Add clue numbers
                    let clueNumber = '';
                    if ((row === 0 && col === 0) || (row === 0 && col === 1) || 
                        (row === 0 && col === 2) || (row === 0 && col === 4) ||
                        (row === 2 && col === 0) || (row === 3 && col === 0) ||
                        (row === 4 && col === 0)) {
                        const acrossClue = Object.entries(crosswordData.across).find(([num, data]) => 
                            data.row === row && data.col === col);
                        const downClue = Object.entries(crosswordData.down).find(([num, data]) => 
                            data.row === row && data.col === col);
                        
                        if (acrossClue) clueNumber = acrossClue[0];
                        else if (downClue) clueNumber = downClue[0];
                    }
                    
                    gridHTML += `
                        <div class="crossword-cell">
                            ${clueNumber ? `<span class="clue-number">${clueNumber}</span>` : ''}
                            <input type="text" maxlength="1" id="${cellId}" 
                                   value="${cellValue}" 
                                   ${isLocked ? 'readonly style="color:#8bc34a;"' : ''}
                                   oninput="this.value = this.value.toUpperCase(); checkCrosswordCompletion()">
                        </div>
                    `;
                }
            }
            gridHTML += '</div>';
            
            // Add clues
            gridHTML += '<div class="crossword-clues">';
            gridHTML += '<div class="clue-list"><h4>Across</h4><ol>';
            for (const [num, clue] of Object.entries(crosswordData.across)) {
                gridHTML += `<li>${num}. ${clue.clue}</li>`;
            }
            gridHTML += '</ol></div>';
            
            gridHTML += '<div class="clue-list"><h4>Down</h4><ol>';
            for (const [num, clue] of Object.entries(crosswordData.down)) {
                gridHTML += `<li>${num}. ${clue.clue}</li>`;
            }
            gridHTML += '</ol></div>';
            gridHTML += '</div>';
            
            // Add success message area
            gridHTML += `
                <div id="crossword-success" class="crossword-success">
                    Puzzle solved! The password is "EUREKA" (from the first word in 1 Across)
                </div>
                <button class="interaction-button" onclick="showComputerInteraction(event)">Back to Computer</button>
            `;
            
            gridHTML += '</div>';
            
            showModal("Computer Login - Crossword Puzzle", gridHTML, '');
            
            // If using hints, lock the first row and column
            if (withHints) {
                for (let i = 0; i < 5; i++) {
                    document.getElementById(`cell-0-${i}`).readOnly = true;
                    document.getElementById(`cell-${i}-0`).readOnly = true;
                }
            }
        }

        // Check if crossword is completed correctly
        function checkCrosswordCompletion() {
            let allCorrect = true;
            
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const cell = document.getElementById(`cell-${row}-${col}`);
                    if (!cell.readOnly && cell.value.toUpperCase() !== crosswordData.solution[row][col]) {
                        allCorrect = false;
                    }
                }
            }
            
            if (allCorrect) {
                const successDiv = document.getElementById('crossword-success');
                successDiv.style.display = 'block';
                addClue('computer-password');
                
                // Automatically log in after a short delay
                setTimeout(loginToComputer, 1500);
            }
        }

        function loginToComputer() {
            addClue('computer-login');
            
            const result = `
                <p>Login successful! The screen displays:</p>
                <div style="font-family: monospace; background: #000; color: #0f0; padding: 10px;">
                    PROJECT PHOENIX - MAIN SYSTEM<br><br>
                    EMERGENCY OVERRIDE CODE: ${gameState.doorCode}<br>
                    Use only if primary systems fail.
                </div>
            `;
            
            showModal("Computer System", result, `<button class="interaction-button" onclick="showComputerInteraction(event)">Back to Computer</button>`);
        }

        function insertUSB(e) {
            if (e) e.stopPropagation();
            if (gameState.inventory.includes('usb-drive')) {
                addClue('usb-inserted');
                
                const result = `
                    <p>The USB drive contains Project Phoenix files, including the emergency door code: ${gameState.doorCode}</p>
                    <p class="story-reveal">The files mention "Subject 314" and "cellular regeneration".</p>
                `;
                
                showModal("USB Drive Contents", result, `
                    <button class="interaction-button" onclick="showComputerInteraction(event)">Back to Computer</button>

                    <button class="interaction-button" onclick="showCrosswordPuzzle(event, true)">View Crossword with Hints</button>
                    <button class="interaction-button" onclick="attemptCrosswordAccess(event)">Attempt Login</button>

                `);
            }
        }



        function attemptCrosswordAccess(e) {
    if (e) e.stopPropagation();

    if (gameState.inventory.includes('usb-drive')) {
        showCrosswordPuzzle(e, false); // No hints even with USB
    } else {
        showModal("Access Denied", `
            <p>You try to access the crossword puzzle, but it's locked.</p>
            <p class="hint">Maybe there's something on a USB drive that could help...</p>
        `, `
            <button class="interaction-button" onclick="modal.style.display='none'">Close</button>
        `);
    }
}

>>>>>>> Stashed changes
        function showWhiteboardInteraction() {
            addClue('whiteboard-examined');
            
            const result = `
                <p>The whiteboard is covered in equations and the number "314" appears repeatedly.</p>
                <p class="story-reveal">A small note reads: 'Subject 314 showed promise for 314 minutes before deterioration.'</p>
            `;
            
            showModal("Whiteboard", result, `<button class="interaction-button" onclick="modal.style.display='none'">Close</button>`);
        }

        function showChartInteraction() {
            addClue('chart-examined');
            
            const result = `
                <p>The periodic table has certain elements circled with notes about "stabilization sequence".</p>
                <p class="story-reveal">The word "POSSESS" is written vertically beside the elements.</p>
            `;
            
            showModal("Chemical Chart", result, `<button class="interaction-button" onclick="modal.style.display='none'">Close</button>`);
        }

        // Raycaster for object interaction
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        function onMouseClick(event) {
            // Don't process clicks if modal is open
            if (modal.style.display === 'flex') return;
            
            // Calculate mouse position in normalized device coordinates
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            // Update the raycaster
            raycaster.setFromCamera(mouse, camera);
            
            // Calculate objects intersecting the raycaster
            const intersects = raycaster.intersectObjects(interactiveObjects, true); // Note the 'true' for recursive checking
            
            if (intersects.length > 0) {
                // Find the first object with an onClick handler
                let clickedObj = intersects[0].object;
                while (clickedObj && !clickedObj.userData.onClick) {
                    clickedObj = clickedObj.parent;
                }
                
                if (clickedObj && clickedObj.userData.onClick) {
                    clickedObj.userData.onClick();
                }
            }
        }

        window.addEventListener('click', onMouseClick, false);

        // Initialize the game
        updateInventory();
    </script>
</body>
</html>