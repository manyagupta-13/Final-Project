<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Escape Room: The Abandoned Laboratory</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #e0e0e0;
        }
        
        #threejs-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #ui-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 5px;
            max-height: 30vh;
            overflow-y: auto;
            border: 1px solid #444;
            z-index: 2;
        }
        
        #inventory {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 5px;
            width: 200px;
            border: 1px solid #444;
            z-index: 2;
        }
        
        #inventory h3 {
            margin-top: 0;
            color: #8bc34a;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        
        #inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            background-color: rgba(68, 68, 68, 0.8);
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.9rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #222;
            padding: 30px;
            border-radius: 5px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #444;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-close:hover {
            color: #fff;
        }
        
        .interaction-buttons {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .interaction-button {
            background-color: #4a4a4a;
            color: #e0e0e0;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        
        .interaction-button:hover {
            background-color: #5a5a5a;
        }
        
        .interaction-button:disabled {
            background-color: #333;
            color: #777;
            cursor: not-allowed;
        }
        
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            gap: 10px;
            margin: 20px auto;
            width: fit-content;
        }
        
        .keypad button {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }
        
        .keypad-display {
            grid-column: span 3;
            background-color: #111;
            color: #f00;
            padding: 10px;
            text-align: center;
            font-family: monospace;
            font-size: 1.5rem;
            border: 1px solid #333;
            margin-bottom: 10px;
        }
        
        .success {
            color: #8bc34a;
        }
        
        .error {
            color: #f44336;
        }
        
        .hint {
            color: #aaa;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .pulsing {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div id="threejs-container"></div>
    
    <div id="inventory">
        <h3>Inventory</h3>
        <div id="inventory-items"></div>
    </div>
    
    <div id="ui-container">
        <div id="room-description">
            <p>Your head throbs as consciousness returns. The sterile scent of ethanol mixes with something more acrid - ozone? Burning? Your vision clears to reveal a dim laboratory, illuminated only by the flickering glow of dying fluorescent lights.</p>
            <p>The cold metal table beneath you explains the stiffness in your limbs. How long were you out? The last thing you remember is... nothing. Just darkness.</p>
            <p>A digital keypad by the reinforced door mocks you with its glowing red display: "LOCKED - ENTER 4-DIGIT CODE". The air feels thick with secrets and the weight of forgotten experiments.</p>
        </div>
    </div>

    <!-- Modal for interactions -->
    <div id="interaction-modal" class="modal">
        <div class="modal-content" id="modal-content">
            <span class="modal-close">&times;</span>
            <div id="modal-title"></div>
            <div id="modal-description"></div>
            <div id="modal-interactions"></div>
        </div>
    </div>

    <!-- Load Three.js and plugins from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>

    <script>
        // Initialize Three.js scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        
        // Enhanced lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
        directionalLight.position.set(5, 10, 5);
        scene.add(directionalLight);
        
        // Camera setup
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 5);
        
        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('threejs-container').appendChild(renderer.domElement);
        
        // Controls with better navigation
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 1, 0);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 3;
        controls.maxDistance = 15;
        controls.maxPolarAngle = Math.PI * 0.9;

        // Room construction - only outer walls
        const roomSize = 15;
        const wallHeight = 7;
        const wallThickness = 0.5;

        // Floor
        const floor = new THREE.Mesh(
            new THREE.PlaneGeometry(roomSize, roomSize),
            new THREE.MeshStandardMaterial({ 
                color: 0x333333,
                roughness: 0.8
            })
        );
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);

        // Outer walls only (no internal dividers)
        const wallMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x222244,
            side: THREE.DoubleSide
        });
        
        // Left wall
        const leftWall = new THREE.Mesh(
            new THREE.PlaneGeometry(roomSize, wallHeight),
            wallMaterial
        );
        leftWall.position.set(-roomSize/2, wallHeight/2, 0);
        leftWall.rotation.y = Math.PI / 2;
        scene.add(leftWall);
        
        // Right wall
        const rightWall = new THREE.Mesh(
            new THREE.PlaneGeometry(roomSize, wallHeight),
            wallMaterial
        );
        rightWall.position.set(roomSize/2, wallHeight/2, 0);
        rightWall.rotation.y = -Math.PI / 2;
        scene.add(rightWall);
        
        // Back wall
        const backWall = new THREE.Mesh(
            new THREE.PlaneGeometry(roomSize, wallHeight),
            wallMaterial
        );
        backWall.position.set(0, wallHeight/2, -roomSize/2);
        scene.add(backWall);

        // Front wall with door opening
        const frontWallLeft = new THREE.Mesh(
            new THREE.PlaneGeometry(roomSize/2 - 1, wallHeight),
            wallMaterial
        );
        frontWallLeft.position.set(-roomSize/4 - 0.5, wallHeight/2, roomSize/2);
        scene.add(frontWallLeft);

        const frontWallRight = new THREE.Mesh(
            new THREE.PlaneGeometry(roomSize/2 - 1, wallHeight),
            wallMaterial
        );
        frontWallRight.position.set(roomSize/4 + 0.5, wallHeight/2, roomSize/2);
        scene.add(frontWallRight);

        // Ceiling
        const ceiling = new THREE.Mesh(
            new THREE.PlaneGeometry(roomSize, roomSize),
            new THREE.MeshStandardMaterial({ color: 0x111122 })
        );
        ceiling.position.set(0, wallHeight, 0);
        ceiling.rotation.x = Math.PI / 2;
        scene.add(ceiling);

        // Interactive objects
        const interactiveObjects = [];

        // Door (purple as you liked)
        const door = new THREE.Mesh(
            new THREE.BoxGeometry(2, 4, 0.1),
            new THREE.MeshStandardMaterial({ color: 0x8844ff })
        );
        door.position.set(0, 2, roomSize/2 - 0.05);
        door.userData = {
            name: "Exit Door",
            description: "Reinforced steel door with a keypad. The only way out.",
            onClick: () => showDoorInteraction()
        };
        scene.add(door);
        interactiveObjects.push(door);

        // Keypad
        const keypad = new THREE.Mesh(
            new THREE.BoxGeometry(0.5, 0.3, 0.05),
            new THREE.MeshStandardMaterial({ color: 0x111111 })
        );
        keypad.position.set(0.8, 1.2, roomSize/2);
        scene.add(keypad);

        // Lab desk
        const desk = new THREE.Mesh(
            new THREE.BoxGeometry(3, 0.8, 1.5),
            new THREE.MeshStandardMaterial({ color: 0x555555 })
        );
        desk.position.set(-3, 0.4, -3);
        desk.userData = {
            name: "Lab Desk",
            description: "Cluttered with research notes and equipment.",
            onClick: () => showDeskInteraction()
        };
        scene.add(desk);
        interactiveObjects.push(desk);

        // Cabinet with drawers
        const cabinet = new THREE.Group();
        cabinet.position.set(3, 1.5, -3);
        
        // Cabinet frame
        const cabinetFrame = new THREE.Mesh(
            new THREE.BoxGeometry(2, 3, 1),
            new THREE.MeshStandardMaterial({ color: 0x333333 })
        );
        cabinet.add(cabinetFrame);
        
        // Drawer 1 (top)
        const drawer1 = new THREE.Mesh(
            new THREE.BoxGeometry(1.8, 0.8, 0.9),
            new THREE.MeshStandardMaterial({ color: 0x444444 })
        );
        drawer1.position.set(0, 0.7, 0);
        drawer1.userData = {
            isDrawer: true,
            drawerNumber: 1,
            locked: false
        };
        cabinet.add(drawer1);
        
        // Drawer 2 (middle)
        const drawer2 = new THREE.Mesh(
            new THREE.BoxGeometry(1.8, 0.8, 0.9),
            new THREE.MeshStandardMaterial({ color: 0x444444 })
        );
        drawer2.position.set(0, 0, 0);
        drawer2.userData = {
            isDrawer: true,
            drawerNumber: 2,
            locked: true
        };
        cabinet.add(drawer2);
        
        // Drawer 3 (bottom)
        const drawer3 = new THREE.Mesh(
            new THREE.BoxGeometry(1.8, 0.8, 0.9),
            new THREE.MeshStandardMaterial({ color: 0x444444 })
        );
        drawer3.position.set(0, -0.7, 0);
        drawer3.userData = {
            isDrawer: true,
            drawerNumber: 3,
            locked: true
        };
        cabinet.add(drawer3);

        cabinet.userData = {
            name: "Supply Cabinet",
            description: "Heavy steel cabinet with three drawers.",
            onClick: () => showCabinetInteraction(),
            isCabinet: true,
            drawers: [drawer1, drawer2, drawer3]
        };
        scene.add(cabinet);
        interactiveObjects.push(cabinet);
        interactiveObjects.push(drawer1);
        interactiveObjects.push(drawer2);
        interactiveObjects.push(drawer3);

        // Bookshelf
        const bookshelf = new THREE.Mesh(
            new THREE.BoxGeometry(4, 5, 0.5),
            new THREE.MeshStandardMaterial({ color: 0x3a2a1f })
        );
        bookshelf.position.set(0, 2.5, -4);
        bookshelf.userData = {
            name: "Bookshelf",
            description: "Floor-to-ceiling case of scientific tomes.",
            onClick: () => showBookshelfInteraction()
        };
        scene.add(bookshelf);
        interactiveObjects.push(bookshelf);

        // Computer terminal
        const terminal = new THREE.Mesh(
            new THREE.BoxGeometry(1, 0.8, 1),
            new THREE.MeshStandardMaterial({ color: 0x222222 })
        );
        terminal.position.set(2, 0.4, 2);
        terminal.userData = {
            name: "Computer Terminal",
            description: "Obsolete computer that still hums with power.",
            onClick: () => showComputerInteraction()
        };
        scene.add(terminal);
        interactiveObjects.push(terminal);

        // Whiteboard
        const whiteboard = new THREE.Mesh(
            new THREE.PlaneGeometry(2, 1.5),
            new THREE.MeshStandardMaterial({ color: 0xffffff })
        );
        whiteboard.position.set(-2, 1.5, 2.5);
        whiteboard.rotation.y = Math.PI;
        whiteboard.userData = {
            name: "Whiteboard",
            description: "Covered in equations and diagrams.",
            onClick: () => showWhiteboardInteraction()
        };
        scene.add(whiteboard);
        interactiveObjects.push(whiteboard);

        // Chemical chart
        const chart = new THREE.Mesh(
            new THREE.PlaneGeometry(2, 1.5),
            new THREE.MeshStandardMaterial({ color: 0x88aaff })
        );
        chart.position.set(4, 1.5, 0);
        chart.rotation.y = -Math.PI/2;
        chart.userData = {
            name: "Chemical Chart",
            description: "Periodic table with disturbing annotations.",
            onClick: () => showChartInteraction()
        };
        scene.add(chart);
        interactiveObjects.push(chart);

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Game state
        const gameState = {
            inventory: [],
            discoveredClues: [],
            puzzlesSolved: 0,
            doorCode: Math.floor(1000 + Math.random() * 9000).toString(),
            storyProgress: 0,
            usedItems: [],
            endingsDiscovered: []
        };

        // Modal functionality
        const modal = document.getElementById('interaction-modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalDescription = document.getElementById('modal-description');
        const modalInteractions = document.getElementById('modal-interactions');
        const modalClose = document.querySelector('.modal-close');

        function showModal(title, description, interactions) {
            modalTitle.innerHTML = `<h2>${title}</h2>`;
            modalDescription.innerHTML = `<p>${description}</p>`;
            modalInteractions.innerHTML = interactions;
            modal.style.display = 'flex';
        }

        modalClose.onclick = function(e) {
            e.stopPropagation();
            modal.style.display = 'none';
        }

        // Prevent clicks on modal from reaching the scene
        modalContent.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Update inventory display
        function updateInventory() {
            const inventoryContainer = document.getElementById('inventory-items');
            inventoryContainer.innerHTML = '';
            
            gameState.inventory.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                itemElement.textContent = item.replace('-', ' ');
                inventoryContainer.appendChild(itemElement);
            });
        }

        // Add item to inventory
        function addToInventory(itemId) {
            if (!gameState.inventory.includes(itemId)) {
                gameState.inventory.push(itemId);
                updateInventory();
            }
        }

        // Add discovered clue
        function addClue(clueId) {
            if (!gameState.discoveredClues.includes(clueId)) {
                gameState.discoveredClues.push(clueId);
                gameState.puzzlesSolved++;
                updateStory();
            }
        }

        // Update story based on progress
        function updateStory() {
            const roomDesc = document.getElementById('room-description');
            
            let baseDescription = `
                <p>Your head throbs as consciousness returns. The sterile scent of ethanol mixes with something more acrid - ozone? Burning? Your vision clears to reveal a dim laboratory, illuminated only by the flickering glow of dying fluorescent lights.</p>
                <p>The cold metal table beneath you explains the stiffness in your limbs. How long were you out? The last thing you remember is... nothing. Just darkness.</p>
                <p>A digital keypad by the reinforced door mocks you with its glowing red display: "LOCKED - ENTER 4-DIGIT CODE". The air feels thick with secrets and the weight of forgotten experiments.</p>
            `;
            
            let additionalText = '';
            
            if (gameState.puzzlesSolved >= 3) {
                additionalText = `
                    <div class="story-reveal">
                        <p>As you explore, you notice references to "Project Phoenix" and "Subject 314". What kind of experiments were conducted here?</p>
                    </div>
                `;
            }
            
            roomDesc.innerHTML = baseDescription + additionalText;
        }

        // Object interaction functions
        function showDoorInteraction() {
            const interactions = `
                <div class="interaction-buttons">
                    <button class="interaction-button" onclick="showDoorCodeInput(event)">Examine Keypad</button>
                    <button class="interaction-button" onclick="showDoorNote(event)">Search Around Door</button>
                </div>
            `;
            showModal("Exit Door", "The reinforced door is your only way out. A keypad demands a 4-digit code.", interactions);
        }

        function showDoorNote(e) {
            if (e) e.stopPropagation();
            if (!gameState.inventory.includes('door-note')) {
                addToInventory('door-note');
                addClue('door-note-found');
                
                const noteContent = `
                    <p>You find a hidden note near the door frame:</p>
                    <p style="font-style: italic; background: #333; padding: 10px; border-left: 3px solid #8bc34a;">
                        "Emergency code: Subject number (314) multiplied by catalyst constant (2.5, round down)"
                    </p>
                    <p>The numbers 314 appear frequently in the lab's notes.</p>
                `;
                
                showModal("Hidden Note Found", noteContent, `<button class="interaction-button" onclick="showDoorInteraction(event)">Back to Door</button>`);
            } else {
                showModal("Exit Door", "You've already found the hidden note near the door.", `<button class="interaction-button" onclick="showDoorInteraction(event)">Back to Door</button>`);
            }
        }

        function showDoorCodeInput(e) {
            if (e) e.stopPropagation();
            let hint = '';
            if (gameState.inventory.includes('door-note')) {
                hint = `<p class="hint">The note says: 314 × 2.5 = 785 → ${gameState.doorCode}</p>`;
            } else {
                hint = '<p class="hint">Look for clues around the lab to find the code.</p>';
            }
            
            const keypadHTML = `
                <div class="keypad">
                    <div class="keypad-display" id="code-display">____</div>
                    <button onclick="addCodeDigit('1', event)">1</button>
                    <button onclick="addCodeDigit('2', event)">2</button>
                    <button onclick="addCodeDigit('3', event)">3</button>
                    <button onclick="addCodeDigit('4', event)">4</button>
                    <button onclick="addCodeDigit('5', event)">5</button>
                    <button onclick="addCodeDigit('6', event)">6</button>
                    <button onclick="addCodeDigit('7', event)">7</button>
                    <button onclick="addCodeDigit('8', event)">8</button>
                    <button onclick="addCodeDigit('9', event)">9</button>
                    <button onclick="addCodeDigit('0', event)">0</button>
                    <button onclick="clearCode(event)">C</button>
                    <button onclick="submitCode(event)">ENTER</button>
                </div>
                ${hint}
            `;
            
            showModal("Door Keypad", "Enter the 4-digit code to escape:", keypadHTML);
        }

        let currentCode = '';
        window.addCodeDigit = function(digit, e) {
            if (e) e.stopPropagation();
            if (currentCode.length < 4) {
                currentCode += digit;
                document.getElementById('code-display').textContent = 
                    currentCode.padEnd(4, '_').split('').join(' ');
            }
        }

        window.clearCode = function(e) {
            if (e) e.stopPropagation();
            currentCode = '';
            document.getElementById('code-display').textContent = '____';
        }

        window.submitCode = function(e) {
            if (e) e.stopPropagation();
            if (currentCode === gameState.doorCode) {
                document.getElementById('code-display').className = 'keypad-display success';
                document.getElementById('code-display').textContent = 'OPEN';
                
                setTimeout(() => {
                    showModal("Escaped!", `
                        <p>The door unlocks with a satisfying clunk. You've escaped!</p>
                        <p>As you leave, you glance back at the lab, its mysteries still unsolved...</p>
                    `, `<button class="interaction-button" onclick="location.reload()">Play Again</button>`);
                    
                    // Animate door opening
                    let angle = 0;
                    const maxAngle = Math.PI / 2;
                    function animateDoor() {
                        if (angle < maxAngle) {
                            angle += 0.01;
                            door.rotation.y = -angle;
                            requestAnimationFrame(animateDoor);
                        }
                    }
                    animateDoor();
                }, 1000);
            } else {
                document.getElementById('code-display').className = 'keypad-display error';
                document.getElementById('code-display').textContent = 'ERR';
                setTimeout(() => {
                    document.getElementById('code-display').className = 'keypad-display';
                    clearCode();
                }, 1000);
            }
        }

        function showDeskInteraction() {
            const interactions = `
                <div class="interaction-buttons">
                    <button class="interaction-button" onclick="searchDesk(event)">Search the Desk</button>
                </div>
            `;
            showModal("Lab Desk", "A stainless steel desk littered with research notes and equipment.", interactions);
        }

        function searchDesk(e) {
            if (e) e.stopPropagation();
            if (!gameState.inventory.includes('small-key')) {
                addToInventory('small-key');
                addClue('desk-searched');
                
                const result = `
                    <p>Under a stack of papers, you find a small brass key and a note with symbols: ☽, ★, ♞, ☀️</p>
                    <p class="story-reveal">The note reads: 'The transformation sequence must follow lunar phases.'</p>
                `;
                
                showModal("Desk Search Results", result, `<button class="interaction-button" onclick="showDeskInteraction(event)">Back to Desk</button>`);
            } else {
                showModal("Lab Desk", "You've already searched the desk thoroughly.", `<button class="interaction-button" onclick="showDeskInteraction(event)">Back to Desk</button>`);
            }
        }

        function showCabinetInteraction() {
            const interactions = `
                <div class="interaction-buttons">
                    <button class="interaction-button" onclick="openCabinetDrawer(1, event)">Open Top Drawer</button>
                    <button class="interaction-button" ${gameState.inventory.includes('small-key') ? '' : 'disabled'} 
                        onclick="openCabinetDrawer(2, event)">Open Middle Drawer</button>
                    <button class="interaction-button" ${gameState.inventory.includes('small-key') ? '' : 'disabled'} 
                        onclick="openCabinetDrawer(3, event)">Open Bottom Drawer</button>
                </div>
            `;
            showModal("Supply Cabinet", "A heavy steel cabinet with three drawers. Some are locked.", interactions);
        }

        function openCabinetDrawer(drawerNumber, e) {
            if (e) e.stopPropagation();
            
            const cabinetObj = interactiveObjects.find(obj => obj.userData.isCabinet);
            if (!cabinetObj) return;
            
            const drawer = cabinetObj.userData.drawers[drawerNumber - 1];
            if (!drawer) return;
            
            if (drawer.userData.locked) {
                if (drawerNumber === 1 || gameState.inventory.includes('small-key')) {
                    // Unlock the drawer
                    drawer.userData.locked = false;
                    
                    if (drawerNumber === 2 && !gameState.inventory.includes('usb-drive')) {
                        addToInventory('usb-drive');
                        gameState.usedItems.push('small-key');
                        addClue('cabinet-opened');
                        
                        const result = `
                            <p>You unlock and open drawer ${drawerNumber}. Inside is a USB drive labeled "Project Phoenix".</p>
                            <p class="story-reveal">A note with the USB reads: 'Emergency override code: ${gameState.doorCode}'</p>
                        `;
                        
                        // Animate drawer opening
                        gsap.to(drawer.position, {
                            z: 0.5,
                            duration: 0.5,
                            onComplete: () => {
                                showModal("Cabinet Contents", result, `
                                    <button class="interaction-button" onclick="showCabinetInteraction(event)">Back to Cabinet</button>
                                `);
                            }
                        });
                    } else {
                        showModal("Cabinet Drawer", `Drawer ${drawerNumber} is empty.`, `
                            <button class="interaction-button" onclick="showCabinetInteraction(event)">Back to Cabinet</button>
                        `);
                    }
                } else {
                    showModal("Locked Drawer", `Drawer ${drawerNumber} is locked. You need a key to open it.`, `
                        <button class="interaction-button" onclick="showCabinetInteraction(event)">Back to Cabinet</button>
                    `);
                }
            } else {
                // Drawer is already unlocked
                if (drawerNumber === 2 && !gameState.inventory.includes('usb-drive')) {
                    addToInventory('usb-drive');
                    const result = `
                        <p>The drawer contains a USB drive labeled "Project Phoenix".</p>
                        <p class="story-reveal">A note with the USB reads: 'Emergency override code: ${gameState.doorCode}'</p>
                    `;
                    showModal("Cabinet Contents", result, `
                        <button class="interaction-button" onclick="showCabinetInteraction(event)">Back to Cabinet</button>
                    `);
                } else {
                    showModal("Cabinet Drawer", `Drawer ${drawerNumber} is empty.`, `
                        <button class="interaction-button" onclick="showCabinetInteraction(event)">Back to Cabinet</button>
                    `);
                }
            }
        }

        function showBookshelfInteraction() {
            const interactions = `
                <div class="interaction-buttons">
                    <button class="interaction-button" onclick="browseBooks(event)">Browse Books</button>
                </div>
            `;
            showModal("Bookshelf", "A collection of scientific tomes, some looking well-used.", interactions);
        }

        function browseBooks(e) {
            if (e) e.stopPropagation();
            addClue('books-browsed');
            
            const result = `
                <p>You find a cryptography book with a marked passage about celestial symbols and sequences.</p>
                <p class="story-reveal">The margin notes mention 'the sequence must be followed precisely'.</p>
            `;
            
            showModal("Cryptography Book", result, `<button class="interaction-button" onclick="showBookshelfInteraction(event)">Back to Bookshelf</button>`);
        }

        function showComputerInteraction() {
            const interactions = `
                <div class="interaction-buttons">
                    <button class="interaction-button" onclick="turnOnComputer(event)">Turn On Computer</button>
                    ${gameState.inventory.includes('usb-drive') ? 
                        `<button class="interaction-button" onclick="insertUSB(event)">Insert USB Drive</button>` : ''}
                </div>
            `;
            showModal("Computer Terminal", "An old computer terminal with a glowing screen.", interactions);
        }

        function turnOnComputer(e) {
            if (e) e.stopPropagation();
            addClue('computer-on');
            
            const result = `
                <p>The computer displays a login screen with username "DR.ALCHEM" already entered.</p>
                <p class="hint">The sticky note on the keyboard says: "Remember - password changes every full moon!"</p>
            `;
            
            showModal("Computer Login", result, `
                <button class="interaction-button" onclick="showPasswordPuzzle(event)">Attempt Login</button>
                <button class="interaction-button" onclick="showComputerInteraction(event)">Back to Computer</button>
            `);
        }

        function showPasswordPuzzle(e) {
            if (e) e.stopPropagation();
            if (gameState.inventory.includes('usb-drive')) {
                loginToComputer();
            } else {
                const passwordHTML = `
                    <p>Username: DR.ALCHEM</p>
                    <p>Password: <input type="password" id="computer-password-input"></p>
                    <button class="interaction-button" onclick="checkComputerPassword(event)">Login</button>
                    <p class="hint">Hint: The password might be related to Archimedes' famous exclamation.</p>
                `;
                
                showModal("Computer Login", "The system demands authentication.", passwordHTML);
            }
        }

        function checkComputerPassword(e) {
            if (e) e.stopPropagation();
            const input = document.getElementById('computer-password-input').value.toUpperCase();
            
            if (input === 'EUREKA') {
                loginToComputer();
            } else {
                alert('ACCESS DENIED\nIncorrect password!');
            }
        }

        function insertUSB(e) {
            if (e) e.stopPropagation();
            if (gameState.inventory.includes('usb-drive')) {
                addClue('usb-inserted');
                
                const result = `
                    <p>The USB drive contains Project Phoenix files, including the emergency door code: ${gameState.doorCode}</p>
                    <p class="story-reveal">The files mention "Subject 314" and "cellular regeneration".</p>
                `;
                
                showModal("USB Drive Contents", result, `<button class="interaction-button" onclick="showComputerInteraction(event)">Back to Computer</button>`);
            }
        }

        function loginToComputer() {
            addClue('computer-login');
            
            const result = `
                <p>Login successful! The screen displays:</p>
                <div style="font-family: monospace; background: #000; color: #0f0; padding: 10px;">
                    PROJECT PHOENIX - MAIN SYSTEM<br><br>
                    EMERGENCY OVERRIDE CODE: ${gameState.doorCode}<br>
                    Use only if primary systems fail.
                </div>
            `;
            
            showModal("Computer System", result, `<button class="interaction-button" onclick="showComputerInteraction(event)">Back to Computer</button>`);
        }

        function showWhiteboardInteraction() {
            addClue('whiteboard-examined');
            
            const result = `
                <p>The whiteboard is covered in equations and the number "314" appears repeatedly.</p>
                <p class="story-reveal">A small note reads: 'Subject 314 showed promise for 314 minutes before deterioration.'</p>
            `;
            
            showModal("Whiteboard", result, `<button class="interaction-button" onclick="modal.style.display='none'">Close</button>`);
        }

        function showChartInteraction() {
            addClue('chart-examined');
            
            const result = `
                <p>The periodic table has certain elements circled with notes about "stabilization sequence".</p>
                <p class="story-reveal">The word "POSSESS" is written vertically beside the elements.</p>
            `;
            
            showModal("Chemical Chart", result, `<button class="interaction-button" onclick="modal.style.display='none'">Close</button>`);
        }

        // Raycaster for object interaction
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    
    function onMouseClick(event) {
        // Don't process clicks if modal is open
        if (modal.style.display === 'flex') return;
        
        // Calculate mouse position in normalized device coordinates
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        
        // Update the raycaster
        raycaster.setFromCamera(mouse, camera);
        
        // Calculate objects intersecting the raycaster
        const intersects = raycaster.intersectObjects(interactiveObjects, true); // Note the 'true' for recursive checking
        
        if (intersects.length > 0) {
            // Find the first object with an onClick handler
            let clickedObj = intersects[0].object;
            while (clickedObj && !clickedObj.userData.onClick) {
                clickedObj = clickedObj.parent;
            }
            
            if (clickedObj && clickedObj.userData.onClick) {
                clickedObj.userData.onClick();
            }
        }
    }

    window.addEventListener('click', onMouseClick, false);

        // Initialize the game
        updateInventory();
    </script>
</body>
</html>